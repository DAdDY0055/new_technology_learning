<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Lambda Authorizer Sample</title>
  </head>
  <body>
    <h1>...Please wait</h1>
    <div id="email"></div>
    <div id="token"></div>
    <br>
    <div></div>
    <a id="admin"></a>
    <br>
    <div></div>
    <a id="leader"></a>
    <br>
    <div></div>
    <a id="users"></a>

    <!-- FirebaseSDKのインポート -->
    <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-app.js"></script>

    <!-- FirebaseAuthのインポート -->
    <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-auth.js"></script>

    <!-- configファイルのインポート -->
    <script src="./js/config.js"></script>

    <!-- axiosのインポート -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>
    <script>
      // User情報の表示
      firebase.auth().onAuthStateChanged(function(user) {
        let h1    = document.querySelector('h1');
        let email = document.querySelector('#email');
        let token = document.querySelector('#token');
        let admin  = document.querySelector('#admin');
        let leader  = document.querySelector('#leader');
        let users  = document.querySelector('#users');

        // API Gatewayで作成したエンドポイントを設定
        // const url = "http://localhost:3000"
        const adminUrl  = "https://x7ow8vkh09.execute-api.ap-northeast-1.amazonaws.com/dev/admin"
        const leaderUrl = "https://x7ow8vkh09.execute-api.ap-northeast-1.amazonaws.com/dev/leaders"
        const userUrl   = "https://x7ow8vkh09.execute-api.ap-northeast-1.amazonaws.com/dev/users"

        if (user) {
          console.log('user', user)
          h1.innerText   = 'ログインしました';
          email.innerHTML = `メールアドレス:${user.email}`;
          user.getIdToken().then(function(accessToken) {
            console.log('accessToken', accessToken)
            token.innerHTML = `JWTトークン:${accessToken}`;

            // リクエスト送信
            axios.get(adminUrl, {
              headers: {
                'Authorization':accessToken,
              }
            }).then(res => {
              admin.innerHTML = `管理者: ${res.data.message}`;
            }).catch(error => {
              admin.innerHTML = `管理者: ${error}`;
            });

            axios.get(leaderUrl, {
              headers: {
                'Authorization':accessToken,
              }
            }).then(res => {
              leader.innerHTML = `リーダー: ${res.data.message}`;
            }).catch(error => {
              leader.innerHTML = `リーダー: ${error}`;
            });

            axios.get(userUrl + "/" + "8eMzOlFSDcVJU8U4zjwNA9pyMlr1", {
              headers: {
                'Authorization':accessToken,
              }
            }).then(res => {
              users.innerHTML = `ユーザー: ${res.data.message}`;
            }).catch(error => {
              users.innerHTML = `ユーザー: ${error}`;
            });
          }, null, ' ');
        }
      });
    </script>
  </body>
</html>
